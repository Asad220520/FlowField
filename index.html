<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Flow Field — Touch Portal</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#080c12; --panel:#0d1421cc; --muted:#9aa4b2; --accent:#78e7ff; --accent2:#a78bfa;
      --ring:#2f4b7d; --text:#e8eef5; --soft:#d3e1ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 900px at 70% 10%, #0d1320 0%, #070b11 70%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    #c{position:fixed;inset:0;display:block;touch-action:none}
    #grain{position:fixed;inset:0;pointer-events:none;opacity:.07;mix-blend-mode:overlay}

    /* --- Top bar --- */
    .topbar{position:fixed;inset:12px 12px auto 12px;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:16px;background:var(--panel);border:1px solid #1c2736;backdrop-filter:blur(8px);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .logo{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
    .dot{width:12px;height:12px;border-radius:50%;background:conic-gradient(from 0deg, #69eafb, #8ef5b6, #e6ff7a, #ffb36b, #ff74a0, #a78bfa, #69eafb);box-shadow:0 0 20px #69eafb}
    .topbar .spacer{flex:1}
    .btn{cursor:pointer;user-select:none;border:1px solid #203044;background:#0b1220;color:var(--soft);border-radius:12px;padding:8px 12px;font-weight:700;display:inline-flex;align-items:center;gap:8px;transition:transform .04s ease, background .2s ease}
    .btn:hover{background:#0d1729}
    .btn:active{transform:translateY(1px)}

    /* --- Side panel (desktop), bottom sheet (mobile) --- */
    .panel{position:fixed;right:12px;top:64px;max-width:360px;width:min(92vw,360px);background:var(--panel);border:1px solid #1c2736;border-radius:18px;padding:12px 14px;backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
    @media (max-width: 820px){
      .panel{left:12px;right:12px;bottom:12px;top:auto;width:auto;max-width:none}
    }
    .row{display:grid;grid-template-columns:140px 1fr 60px;align-items:center;gap:10px;margin:10px 0}
    .row label{font-size:12px;color:var(--muted)}
    .row input[type=range]{width:100%}
    .row output{text-align:right;font-variant-numeric:tabular-nums;color:#cfe7ff}
    .toggle{display:flex;align-items:center;gap:10px;margin-top:6px}
    .toggle input{transform:scale(1.15)}
    .pill{display:inline-flex;gap:6px;flex-wrap:wrap}
    .pill .btn{padding:6px 10px;border-radius:999px}

    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .footer{position:fixed;left:12px;bottom:10px;color:#7b8799;font-size:12px;opacity:.9}

    .kbd{padding:.1em .4em;border:1px solid #2b3a4f;border-bottom-width:2px;border-radius:6px;background:#0b1220;color:#c6d4e3}
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <canvas id="grain"></canvas>

  <div class="topbar">
    <div class="logo"><span class="dot"></span>Flow Field • Touch Portal</div>
    <div class="spacer"></div>
    <button class="btn" id="btnFull">Полный экран</button>
    <button class="btn" id="btnSave">PNG</button>
  </div>

  <div class="panel" id="panel">
    <div class="row"><label>Частиц</label><input id="count" type="range" min="500" max="12000" step="100"><output id="countOut"></output></div>
    <div class="row"><label>Скорость</label><input id="speed" type="range" min="0.1" max="6" step="0.1"><output id="speedOut"></output></div>
    <div class="row"><label>Толщина</label><input id="thick" type="range" min="0.2" max="3.5" step="0.1"><output id="thickOut"></output></div>
    <div class="row"><label>Масштаб поля</label><input id="scale" type="range" min="100" max="1200" step="10"><output id="scaleOut"></output></div>
    <div class="row"><label>Сдвиг цвета</label><input id="hue" type="range" min="0" max="360" step="1"><output id="hueOut"></output></div>
    <div class="row"><label>Сила сбора</label><input id="gather" type="range" min="0" max="3" step="0.05"><output id="gatherOut"></output></div>

    <div class="toggle">
      <input type="checkbox" id="gatherAll">
      <label for="gatherAll">Собирать ВСЕ линии к точке касания/курсора</label>
    </div>
    <div class="toggle">
      <input type="checkbox" id="pinPoint">
      <label for="pinPoint">Закрепить точку сбора (долгое касание тоже закрепляет)</label>
    </div>

    <div class="pill" style="margin-top:8px">
      <button class="btn" data-preset="calm">Спокойный</button>
      <button class="btn" data-preset="neon">Неон</button>
      <button class="btn" data-preset="storm">Шторм</button>
      <button class="btn" data-preset="dust">Пыльца</button>
    </div>

    <div class="hint">Подсказки: двойной тап — скрыть/показать панель. Удерживай палец — точка сбора. <span class="kbd">R</span> — новое поле, <span class="kbd">H</span> — скрыть UI.</div>
  </div>

  <div class="footer">© Flow Field • мобильные жесты, пресеты и режим «собрать всё»</div>

<script>
// ------- utils -------
const rand=(a=1,b=0)=>a+(b-a)*Math.random();
const clamp=(x,min,max)=>Math.min(max,Math.max(min,x));
const lerp=(a,b,t)=>a+(b-a)*t;
const RAD=180/Math.PI;
const hsla=(h,s,l,a=1)=>`hsla(${h},${s}%,${l}%,${a})`;

// ------- noise -------
class SimplexNoise{constructor(r=Math){this.p=new Uint8Array(256);for(let i=0;i<256;i++)this.p[i]=i;for(let i=255;i>0;i--){const n=r.random()*(i+1)|0;const q=this.p[i];this.p[i]=this.p[n];this.p[n]=q}this.perm=new Uint8Array(512);for(let i=0;i<512;i++)this.perm[i]=this.p[i&255];}
  noise2D(xin,yin){const g=new Float32Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);const F2=0.5*(Math.sqrt(3)-1),G2=(3-Math.sqrt(3))/6;let n0=0,n1=0,n2=0;const s=(xin+yin)*F2;const i=Math.floor(xin+s),j=Math.floor(yin+s);const t=(i+j)*G2;const X0=i-t,Y0=j-t;const x0=xin-X0,y0=yin-Y0;let i1,j1;if(x0>y0){i1=1;j1=0}else{i1=0;j1=1}const x1=x0-i1+G2,y1=y0-j1+G2,x2=x0-1+2*G2,y2=y0-1+2*G2;const ii=i&255,jj=j&255;const gi0=this.perm[ii+this.perm[jj]]%12*2,gi1=this.perm[ii+i1+this.perm[jj+j1]]%12*2,gi2=this.perm[ii+1+this.perm[jj+1]]%12*2;let t0=0.5-x0*x0-y0*y0;if(t0>=0){t0*=t0;n0=t0*t0*(g[gi0]*x0+g[gi0+1]*y0)}let t1=0.5-x1*x1-y1*y1;if(t1>=0){t1*=t1;n1=t1*t1*(g[gi1]*x1+g[gi1+1]*y1)}let t2=0.5-x2*x2-y2*y2;if(t2>=0){t2*=t2;n2=t2*t2*(g[gi2]*x2+g[gi2+1]*y2)}return 70*(n0+n1+n2)} }

// ------- canvas -------
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
const grainCanvas=document.getElementById('grain');
const gctx=grainCanvas.getContext('2d');
let DPR=Math.min(2,window.devicePixelRatio||1);
function resize(){const W=Math.floor(innerWidth*DPR),H=Math.floor(innerHeight*DPR);canvas.width=W;canvas.height=H;canvas.style.width=innerWidth+'px';canvas.style.height=innerHeight+'px';ctx.setTransform(1,0,0,1,0,0);ctx.scale(DPR,DPR);grainCanvas.width=W;grainCanvas.height=H;grainCanvas.style.width=innerWidth+'px';grainCanvas.style.height=innerHeight+'px';drawGrain();}
addEventListener('resize',resize);resize();

function drawGrain(){const img=gctx.createImageData(grainCanvas.width,grainCanvas.height);for(let i=0;i<img.data.length;i+=4){const v=200+(Math.random()*55)|0;img.data[i]=img.data[i+1]=img.data[i+2]=v;img.data[i+3]=255;}gctx.putImageData(img,0,0)}

// ------- simulation -------
const noise=new SimplexNoise();
let particles=[];
const isMobile = /Mobi|Android/i.test(navigator.userAgent);
const defaultCount = isMobile? 2200 : 4000;
const params={count:defaultCount,speed:2.2,thick:0.9,scale:460,hue:210,gather:1.2,gatherAll:false,pinPoint:false,paused:false};
let frame=0,seed=Math.random()*1000;

class Particle{constructor(){this.reset(true);}reset(randomPos=false){this.x=randomPos?rand(0,innerWidth):innerWidth/2;this.y=randomPos?rand(0,innerHeight):innerHeight/2;this.vx=0;this.vy=0;this.life=rand(100,400);this.age=0;this.h=rand(0,360);}step(){this.age++;if(this.age>this.life)this.reset(true);
  const n=noise.noise2D((this.x+seed)/params.scale,(this.y-seed)/params.scale);
  const a=n*Math.PI*2 + frame*0.002;
  let ax=Math.cos(a)*0.15, ay=Math.sin(a)*0.15;

  // attraction logic
  const target = point.active? point : null;
  if(target){
    let dx=target.x-this.x, dy=target.y-this.y; const d2=dx*dx+dy*dy; const d=Math.sqrt(d2)||1;
    let f = 0;
    if(params.gatherAll){ // strong pull for everyone
      f = params.gather * 0.9;
    } else { // local pull with falloff
      const radius = 160; let inf = 1 - Math.min(1, d / radius); inf = Math.pow(inf, 2.2); f = params.gather * 1.2 * inf;
    }
    ax += (dx/d) * f; ay += (dy/d) * f;
  }

  this.vx = (this.vx + ax) * 0.9; this.vy = (this.vy + ay) * 0.9;
  const spd = params.speed * 0.8; this.x += this.vx*spd; this.y += this.vy*spd;
  if(this.x<0)this.x+=innerWidth; if(this.x>innerWidth)this.x-=innerWidth; if(this.y<0)this.y+=innerHeight; if(this.y>innerHeight)this.y-=innerHeight;}}

function rebuildParticles(){const target=params.count|0; if(target>particles.length){for(let i=particles.length;i<target;i++)particles.push(new Particle());}else if(target<particles.length){particles.length=target;}}

// ------- UI bindings -------
const $=id=>document.getElementById(id);
const ranges=[["count","countOut",v=>v],["speed","speedOut",v=>(+v).toFixed(1)],["thick","thickOut",v=>(+v).toFixed(1)],["scale","scaleOut",v=>v],["hue","hueOut",v=>`${v}°`],["gather","gatherOut",v=>(+v).toFixed(2)]];
for(const [k,out,fmt] of ranges){const el=$(k), eo=$(out); el.value=params[k]; eo.textContent=fmt(params[k]); el.addEventListener('input',()=>{params[k]=parseFloat(el.value); eo.textContent=fmt(el.value); if(k==='count') rebuildParticles();});}
$('gatherAll').checked=params.gatherAll; $('gatherAll').addEventListener('change',e=>params.gatherAll=e.target.checked);
$('pinPoint').checked=params.pinPoint; $('pinPoint').addEventListener('change',e=>{params.pinPoint=e.target.checked; if(!params.pinPoint) point.active=false});

// Presets
for(const b of document.querySelectorAll('[data-preset]')){
  b.addEventListener('click',()=>{
    const p=b.getAttribute('data-preset');
    if(p==='calm'){params.speed=1.6; params.thick=0.7; params.scale=520; params.hue=210; params.gather=0.9}
    if(p==='neon'){params.speed=2.6; params.thick=1.2; params.scale=360; params.hue=300; params.gather=1.6}
    if(p==='storm'){params.speed=3.6; params.thick=1.4; params.scale=280; params.hue=40;  params.gather=2.2}
    if(p==='dust'){params.speed=1.0; params.thick=0.5; params.scale=700; params.hue=150; params.gather=0.6}
    for(const [k,out,fmt] of ranges){$(k).value=params[k]; $(out).textContent=fmt(params[k]);}
  })
}

// Top actions
$('btnSave').onclick=()=>{const a=document.createElement('a'); a.download='flow-field.png'; a.href=canvas.toDataURL('image/png'); a.click();};
$('btnFull').onclick=()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen().catch(()=>{});} else {document.exitFullscreen();}};

// ------- input (cursor/touch) -------
const point={x:innerWidth/2,y:innerHeight/2,active:false};
let longPressTimer=null; let panelHidden=false; let lastTap=0;

function activateAt(x,y){point.x=x; point.y=y; point.active=true;}

addEventListener('pointerdown',e=>{activateAt(e.clientX,e.clientY); if(params.pinPoint) return; clearTimeout(longPressTimer); longPressTimer=setTimeout(()=>{$('pinPoint').checked=true; params.pinPoint=true;},500)});
addEventListener('pointermove',e=>{if(point.active || params.gatherAll){activateAt(e.clientX,e.clientY)}});
addEventListener('pointerup',()=>{clearTimeout(longPressTimer); if(!params.pinPoint){point.active=false}});
addEventListener('pointerleave',()=>{if(!params.pinPoint){point.active=false}});

addEventListener('keydown',e=>{if(e.key==='h'||e.key==='H'){togglePanel()} if(e.key==='r'||e.key==='R'){seed=Math.random()*1000}});
addEventListener('dblclick',togglePanel); addEventListener('doubletap',togglePanel);
function togglePanel(){panelHidden=!panelHidden; const p=$('panel'); p.style.display=panelHidden?'none':'block';}

// ------- drawing -------
function clearCanvas(prime=false){ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.globalCompositeOperation='source-over';ctx.fillStyle='rgba(8,12,18,1)';ctx.fillRect(0,0,innerWidth,innerHeight);ctx.restore();if(prime){const g=ctx.createRadialGradient(innerWidth/2,innerHeight/2,0,innerWidth/2,innerHeight/2,Math.max(innerWidth,innerHeight)*0.8);g.addColorStop(0,'rgba(15,20,30,0)');g.addColorStop(1,'rgba(0,0,0,0.35)');ctx.fillStyle=g;ctx.fillRect(0,0,innerWidth,innerHeight);}}

function loop(){requestAnimationFrame(loop); if(params.paused)return; frame++;
  // subtle motion trail
  ctx.globalCompositeOperation='source-over'; ctx.fillStyle='rgba(11,15,20,0.06)'; ctx.fillRect(0,0,innerWidth,innerHeight);
  ctx.globalCompositeOperation='lighter'; ctx.lineCap='round'; ctx.lineWidth=params.thick;
  const hueBase=params.hue;
  for(let i=0;i<particles.length;i++){
    const p=particles[i]; const x0=p.x,y0=p.y; p.step();
    ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(p.x,p.y);

    // color: angle to point -> rainbow near target, base hue otherwise
    let dx=(point.x||0)-p.x, dy=(point.y||0)-p.y; const d=Math.hypot(dx,dy)||1;
    const angleHue=((Math.atan2(dy,dx)*RAD)+360)%360; const baseHue=(hueBase+(i*0.03+frame*0.1))%360;
    const mix = point.active? (params.gatherAll? 1 : clamp(Math.exp(-d/220),0,1)) : 0;
    const h=baseHue*(1-mix) + angleHue*mix; const sat=80, light=60, alpha= params.gatherAll? 0.65 : 0.55;
    ctx.strokeStyle=hsla(h, sat, light, alpha); ctx.stroke();
  }
}

clearCanvas(true); rebuildParticles(); loop();
</script>
</body>
</html>
